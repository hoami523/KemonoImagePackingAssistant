# 图片打包助手 - 图片抓取与打包实现原理

本扩展的核心功能是自动抓取bilibili文字专栏页面中的所有图片，并将其打包为ZIP文件下载。下面详细解释其实现原理。

---

## 1. 内容脚本注入

通过Chrome扩展的`content_scripts`机制，在manifest.json中配置：
```json
"content_scripts": [
  {
    "matches": ["https://bilibili.com/opus/*"],
    "js": ["lib/jszip.js", "content.js"],
    "css": ["content.css"]
  }
]
```
这样，访问bilibili专栏页面时，扩展会自动注入JS和CSS。

---

## 2. 图片抓取的实现方式

### 2.1 DOM遍历
- 通过`document.querySelectorAll('img')`获取页面上所有`<img>`标签。
- 遍历所有图片节点，读取其`src`属性。

### 2.2 过滤逻辑
- 过滤掉`src`为空、base64（data:）图片、包含`avatar`或`icon`等关键词的图片（通常为头像或小图标）。
- 通过`getBoundingClientRect()`判断图片尺寸，过滤掉宽高小于50像素的小图片。

### 2.3 结果示例
最终得到一个图片对象数组：
```js
[
  { src: 'https://i0.hdslb.com/bfs/article/xxx.jpg', index: 1, filename: 'image_1.jpg' },
  ...
]
```

---

## 3. 图片下载与打包

### 3.1 图片下载
- 使用`fetch` API对每个图片URL发起请求，获取图片二进制数据（Blob）。
- 采用`mode: 'cors'`，`credentials: 'omit'`，以适应大部分图片的跨域策略。
- 若下载失败（如跨域被拒绝），则跳过该图片。

### 3.2 文件类型识别
- 通过Blob的`type`属性判断图片格式（如image/png、image/jpeg等），自动为每张图片分配合适的扩展名。

### 3.3 JSZip打包
- 利用`JSZip`库，将每个图片Blob以文件形式添加到zip包中。
- 所有图片下载完成后，调用`zip.generateAsync({ type: 'blob' })`生成最终的zip文件。

### 3.4 触发浏览器下载
- 通过`URL.createObjectURL`生成zip文件的临时下载链接。
- 创建一个隐藏的`<a>`标签，设置`href`和`download`属性，自动触发点击，实现文件保存。

---

## 4. 进度与用户体验
- 下载和打包过程中，实时更新进度条和状态文本。
- 下载按钮在处理时禁用，防止重复操作。
- 下载完成后自动恢复界面状态。

---

## 5. 兼容性与适配
- 浮动图标和菜单通过CSS适配PC和移动端。
- 拖拽功能同时支持鼠标和触摸事件。

---

## 总结
本扩展通过内容脚本直接操作页面DOM，结合现代Web API（如fetch、Blob、JSZip），实现了无需后端、纯前端的高效图片批量抓取与打包下载，兼容性强，用户体验良好。

如需进一步了解实现细节，可直接阅读`content.js`源码。 